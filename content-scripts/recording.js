(()=>{"use strict";var e=function(){function e(e,t,r,s){var i=this;this.win=e,this.node=t,this.rec=r,this.iframeElement=s,this.prepEvent=function(e){var t;return i.flushObserver(),(null===(t=e.target)||void 0===t?void 0:t.DOMRecID)||0},this.mouseListener=function(e){for(var t,r=e.clientX,s=e.clientY,n=i.iframeElement,a=e.target,o=i.node;n;){var c=n.getBoundingClientRect();r+=c.left,s+=c.top,a=n;var l=n.ownerDocument.DOMRecInner;o=l.node,n=l.iframeElement}if(o.contains(a)){i.flushObserver();var h,u=o.getBoundingClientRect();switch(r-=u.left,s-=u.top,e.type){case"mousemove":h="m";break;case"mouseup":h="u";break;case"mousedown":h="n";break;default:throw new Error("Unknown event type: "+e.type)}i.rec.actions.push(((t={})[h]=[Math.round(r),Math.round(s)],t))}},this.scrollListener=function(e){if(i.node.contains(e.target)){var t=i.prepEvent(e);t&&i.rec.pushScrollAction(t,e.target)}},this.inputListener=function(e){var t;if(i.node.contains(e.target)){var r=i.prepEvent(e);if(r){var s=null;"value"in e.target&&(s=e.target.value),console.log(s,"just in order to have tsc tolerating the unused variable for now"),i.rec.actions.push(((t={}).i=[r,e.target.value],t))}}},this.flushListener=function(e){var t;if(i.node.contains(e.target)){var r=i.prepEvent(e);r&&i.rec.actions.push(((t={}).f=r,t))}},this.canvasListener=function(e){var t;if(i.node.contains(e.target)){var r=i.prepEvent(e);r&&i.rec.actions.push(((t={}).c=[r,e.target.toDataURL(),"didDraw"],t))}},this.focusListener=function(){return i.rec.evaluateFocus()},console.log("rec",r),t.ownerDocument.DOMRecInner=this;var n=[],a=r.serializeNode(t,n);if(!a)throw new Error("Can't record element "+t.tagName);this.initialState=[a,n],this.observer=new MutationObserver(r.observerCallback),this.observer.observe(t,{attributes:!0,characterData:!0,childList:!0,subtree:!0}),e.addEventListener("input",this.inputListener,{capture:!0,passive:!0}),e.addEventListener("mousemove",this.mouseListener,{capture:!0,passive:!0}),e.addEventListener("mousedown",this.mouseListener,{capture:!0,passive:!0}),e.addEventListener("mouseup",this.mouseListener,{capture:!0,passive:!0}),e.addEventListener("forceStyleFlush",this.flushListener,{capture:!0,passive:!0}),e.addEventListener("didDrawCanvas",this.canvasListener,{capture:!0,passive:!0}),e.addEventListener("focus",this.focusListener,{capture:!0,passive:!0})}return e.prototype.stop=function(){this.flushObserver(),this.observer.disconnect(),this.win.removeEventListener("input",this.inputListener,{capture:!0,passive:!0}),this.win.removeEventListener("mousemove",this.mouseListener,{capture:!0,passive:!0}),this.win.removeEventListener("mousedown",this.mouseListener,{capture:!0,passive:!0}),this.win.removeEventListener("mouseup",this.mouseListener,{capture:!0,passive:!0}),this.win.removeEventListener("forceStyleFlush",this.flushListener,{capture:!0,passive:!0}),this.win.removeEventListener("didDrawCanvas",this.canvasListener,{capture:!0,passive:!0}),this.win.removeEventListener("focus",this.focusListener,{capture:!0,passive:!0}),this.rec.deleteAllDOMRecIDs(this.node)},e.prototype.flushObserver=function(){this.rec.observerCallback(this.observer.takeRecords())},e}(),t=function(){function t(t){var r=this;this.node=t,this.nextID=1,this.actions=[],this.lastActionTime=Date.now(),this.nestedObserverCallbacks=0,this.focusedElement=null,this.observerCallback=this.callback.bind(this),this.iframeLoadedListener=function(e){return r.iframeLoaded(e.target,r.actions)},this.rootFrame=new e(window,t,this,null),this.evaluateFocus(),this.rootFrame.initialState[1]=this.rootFrame.initialState[1].concat(this.actions),this.actions=[]}return t.prototype.clearFakeFocus=function(){if(this.focusedElement){this.focusedElement.removeAttribute("fakeFocus");for(var e=this.focusedElement;e;){e.removeAttribute("fakeFocusWithin"),e=e.parentElement||e.ownerDocument.DOMRecInner.iframeElement}}},t.prototype.evaluateFocus=function(){for(var e,t=this.rootFrame;;){if(e=t.win.document.activeElement,!t.node.contains(e)){e=null;break}if("IFRAME"!==e.tagName)break;t=e.contentDocument.DOMRecInner}if(e!==this.focusedElement){this.clearFakeFocus(),e.setAttribute("fakeFocus","");for(var r=e;r;){r.setAttribute("fakeFocusWithin","");var s=r.parentElement;s?r=s:(r.ownerDocument.DOMRecInner.flushObserver(),r=r.ownerDocument.DOMRecInner.iframeElement)}this.rootFrame.flushObserver(),this.focusedElement=e}},t.prototype.stop=function(){var e=this.rootFrame.node.getBoundingClientRect().width,t=this.rootFrame.node.getBoundingClientRect().height,r={initialState:this.rootFrame.initialState,actions:this.actions,width:e,height:t};return this.rootFrame.stop(),this.clearFakeFocus(),this.rootFrame=null,r},t.prototype.allowAttribute=function(e,t){switch(t){case"src":case"srcdoc":if("IFRAME"===e.tagName)return!1;break;case"title":return!1}return!0},t.prototype.pushScrollAction=function(e,t,r){var s=r||this.actions,i=t.elementScrolledIntoView;if(i){var n={};if(i.DOMRecID){var a="elementScrolledIntoViewOffset"in t?t.elementScrolledIntoViewOffset:null;n.s=[e,i.DOMRecID,a]}else{if("bottom"!==i)throw new Error("Unknown scrolledIntoView: "+i);n.s=[e,i]}s.push(n)}else console.log("Warning: unknown scroll operation ignored")},t.prototype.serializeNode=function(e,t){if("DOMRecID"in e)throw new Error("Already serialized "+e.DOMRecID);var r=this.nextID++,s={id:r};switch(e.DOMRecID=r,e.nodeType){case Node.ELEMENT_NODE:var i=e.tagName;switch(i){case"INPUT":case"TEXTAREA":(h={}).i=[r,e.value],t.push(h);var n=e.ownerDocument.DOMRecInner.scrollListener;e.addEventListener("scroll",n,{passive:!0});break;case"PRE":case"DIV":if(e.classList.contains("hidden")&&window.DOMREC_SKIP_HIDDEN_IDS.indexOf(e.id)>=0)return delete e.DOMRecID,null;n=e.ownerDocument.DOMRecInner.scrollListener,e.addEventListener("scroll",n,{passive:!0});break;case"SCRIPT":case"LINK":return delete e.DOMRecID,null;case"CANVAS":(h={}).c=[r,e.toDataURL()],t.push(h);break;case"IFRAME":this.attachToIFrame(e,t)}s[""]=i;for(var a={},o=!1,c=0,l=e.attributes;c<l.length;c++){var h,u=(h=l[c]).name;this.allowAttribute(e,u)&&(a[u]=h.value,o=!0)}o&&(s.a=a);for(var d=[],v=0,p=e.childNodes;v<p.length;v++){var f=p[v],m=this.serializeNode(f,t);m&&d.push(m)}d.length>0&&(s.c=d),(e.scrollLeft||e.scrollTop)&&this.pushScrollAction(r,e,t);break;case Node.TEXT_NODE:case Node.CDATA_SECTION_NODE:var D=e.data;D.length>0&&(s.d=D);break;case Node.PROCESSING_INSTRUCTION_NODE:case Node.COMMENT_NODE:break;default:throw delete e.DOMRecID,new Error("Bad node "+e)}return s},t.prototype.attachToIFrame=function(e,t){e.addEventListener("load",this.iframeLoadedListener),e.contentDocument&&"complete"===e.contentDocument.readyState&&this.iframeLoaded(e,t)},t.prototype.iframeLoaded=function(t,r){t.DOMRecInner=new e(t.contentWindow,t.contentDocument.body,this,t);var s=t.DOMRecInner.initialState[0];s.c||(s.c=[]);for(var i=t.contentDocument.head.firstElementChild;i;i=i.nextElementSibling)if("STYLE"===i.tagName)s.c.push(this.serializeNode(i,t.DOMRecInner.initialState[1])),this.deleteAllDOMRecIDs(i);else if("LINK"===i.tagName&&"stylesheet"===i.getAttribute("rel")){var n=i.getAttribute("href"),a=n.lastIndexOf("/");a>=0&&(n=n.substring(a+1));var o={"":"STYLE",a:{cached:n},id:this.nextID++};s.c.push(o)}var c={"":"STYLE",c:[{d:".scrollbar { opacity: 0 ! important }",id:this.nextID++}],id:this.nextID++};s.c.push(c);var l={};l.e=[t.DOMRecID,s],r.push(l);for(var h=0,u=t.DOMRecInner.initialState[1];h<u.length;h++){var d=u[h];r.push(d)}delete t.DOMRecInner.initialState},t.prototype.detachFromIFrame=function(e){e.DOMRecInner&&e.DOMRecInner.stop(),e.removeEventListener("load",this.iframeLoadedListener)},t.prototype.label=function(e){this.callback(this.observer.takeRecords());var t={};t.l=e,this.actions.push(t)},t.prototype.delay=function(e){this.lastActionTime-=1e3*e},t.prototype.deleteAllDOMRecIDs=function(e){delete e.DOMRecID;var t=e.ownerDocument.DOMRecInner.scrollListener;e.removeEventListener("scroll",t,{passive:!0});for(var r=e.firstChild;r;r=r.nextSibling)r.DOMRecID&&this.deleteAllDOMRecIDs(r);"IFRAME"===e.tagName&&this.detachFromIFrame(e)},t.prototype.callback=function(e,t){if(0===this.nestedObserverCallbacks){var r=Date.now();r>this.lastActionTime&&((w={}).d=r-this.lastActionTime,this.actions.push(w))}++this.nestedObserverCallbacks;try{for(var s=0,i=e;s<i.length;s++)if((d=i[s]).target.DOMRecID&&"childList"===d.type)for(var n=0,a=d.removedNodes;n<a.length;n++){var o=a[n],c=o.DOMRecID;c&&((w={}).v=c,this.actions.push(w),this.deleteAllDOMRecIDs(o))}for(var l=[],h=0,u=e;h<u.length;h++){var d,v=(d=u[h]).target,p=v.DOMRecID;if(p)switch(d.type){case"attributes":var f=d.attributeName;this.allowAttribute(v,f)&&((w={}).r=[p,f,v.getAttribute(f)],this.actions.push(w));break;case"characterData":(w={}).t=[p,v.data],this.actions.push(w);break;case"childList":d.addedNodes.length>0&&!v.DOMRecNodesAdded&&(v.DOMRecNodesAdded=!0,l.push(v))}}for(var m=0,D=l;m<D.length;m++){var b=D[m];delete b.DOMRecNodesAdded;for(var O=b.lastChild;O;O=O.previousSibling)if(!O.DOMRecID){var w={},E=[],I=this.serializeNode(O,E);if(I){var L=O.nextSibling;w.a=[b.DOMRecID,L?L.DOMRecID:null,I,E],this.actions.push(w)}}}}catch(e){throw--this.nestedObserverCallbacks,console.log("MutationObserver exception: ",e),e}--this.nestedObserverCallbacks,0===this.nestedObserverCallbacks&&(this.lastActionTime=Date.now())},t}();"undefined"!=typeof window&&(window.DOMRecorder=t,window.DOMRecFrame=e)})();